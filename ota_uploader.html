<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ESP32 BLE OTA Uploader</title>
<style>
body { font-family: sans-serif; padding: 20px; background:#111; color:#eee; }
button { padding:10px 20px; margin:10px 0; font-size:16px; }
progress { width:100%; height:20px; }
</style>
</head>
<body>

<h2>ESP32 BLE OTA Uploader</h2>

<input type="file" id="fileInput" accept=".bin"><br><br>

<button id="connectBtn">Connect to ESP32</button>
<button id="uploadBtn" disabled>Upload Firmware</button>

<p id="status">Status: Idle</p>
<progress id="prog" value="0" max="100"></progress>

<script>
const SERVICE_UUID = "6e400001-b5a3-f393-e0a9-e50e24dcca9e";
const CHAR_UUID    = "6e400002-b5a3-f393-e0a9-e50e24dcca9e";

let bleDevice;
let bleServer;
let otaChar;
let firmware;

document.getElementById("fileInput").onchange = (e)=>{
  firmware = e.target.files[0];
};

document.getElementById("connectBtn").onclick = async () => {
  try {
    document.getElementById("status").innerText = "Status: Connecting...";
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{ name: "ESP32-OTA-BLE" }],
      optionalServices: [SERVICE_UUID]
    });

    bleServer = await bleDevice.gatt.connect();
    let service = await bleServer.getPrimaryService(SERVICE_UUID);
    otaChar = await service.getCharacteristic(CHAR_UUID);

    document.getElementById("status").innerText = "Status: Connected ✔️";
    document.getElementById("uploadBtn").disabled = false;

  } catch (err) {
    document.getElementById("status").innerText = "Error: " + err;
  }
};

document.getElementById("uploadBtn").onclick = async () => {
  if (!firmware) {
    alert("Choose a .bin file first!");
    return;
  }

  const total = firmware.size;
  const sizeHeader = new TextEncoder().encode("SIZE:" + total + "\n");

  document.getElementById("status").innerText = "Sending size header...";
  await otaChar.writeValue(sizeHeader);

  const chunkSize = 256; // Safe for BLE on mobile
  let offset = 0;
  const reader = new FileReader();

  reader.onload = async (e) => {
    const data = new Uint8Array(e.target.result);

    document.getElementById("status").innerText = "Uploading firmware...";
    while (offset < total) {
      let end = Math.min(offset + chunkSize, total);
      let slice = data.slice(offset, end);

      await otaChar.writeValue(slice);

      offset = end;
      let pct = Math.floor((offset / total) * 100);
      document.getElementById("prog").value = pct;
      document.getElementById("status").innerText = `Uploading... ${pct}%`;
    }

    document.getElementById("status").innerText = "Upload complete. ESP32 rebooting...";
  };

  reader.readAsArrayBuffer(firmware);
};
</script>
</body>
</html>